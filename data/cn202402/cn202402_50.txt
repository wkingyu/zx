低资源集群中的大语言模型分布式推理技术 冯文佼   等 热点专题
中兴通讯技术
2024  年 4 月    第 30 卷第  2 期   Apr . 2024    Vol . 30  No. 2源消耗两个维度来深入分析这一新算子的性能 。
在计算结果理论正确性方面 ，该推理范式先在单个计算
卡上对 Reduce 后数据进行 LayerNorm ，再将结果 Broadcast 给
其他计算卡 。这与先将 Reduce 后的结果 Broadcast 给其他计
算卡 ，再在各计算卡上分别进行 LayerNorm ，计算得到的结
果等价 。而在资源消耗方面 ，All-Reduce+LayerNorm 算子不
会牺牲显存 ，因为中间结果 Z通过各计算卡并行 LayerNorm
操作 。得到 Z'之后 ，LayerNorm 产生的临时变量立即被释放 。
因此 ，这种方法主要影响峰值显存使用而非总显存 。
总的来说 ，我们提出一种高兼容的分布式推理范式 ，该
范式将 Reduce+LayerNorm+Broadcast 算子合并为 All-Reduce+
LayerNorm 算子 ，在确保计算结果理论正确性 、资源消耗等
价的前提下 ，统一 LLM 张量并行范式的通信原语为 All-
Reduce 。一方面 ，我们可以根据实际环境 ，灵活使用 MPI、
Gloo、NCCL 、Hovorod 、PS等第三方通信库 （或自研通信
库）来满足个性化的推理需求 ；另一方面 ，All-Reduce 原语
的执行效率比分别执行 Reduce 和Broadcast 原语更高 ，具有
更宽阔的通信优化空间 。
2.2 面向主机内外差异带宽的高性能 All-Reduce 通信算法
当前基于 All-Reduce 的通信优化研究主要集中在缓解模
型训练阶段的长期通信不平衡问题 。然而 ，在追求低延迟和
高吞吐的推理阶段 ，跨主机 All-Reduce 通信中低带宽网络引
发的瓶颈问题更值得关注 。如图 2所示 ，数据中心的分层拓
扑结构将机器分至机架并连接至 ToR交换机 ，以保障机架内
主机间共享完整链路带宽 。但带宽通常局限于 1~25 Gbit/s ，
这与主机内多卡间上百 Gbit/s 的高速通信相距甚远[15]。为此我们开发了一种基于通信树的高效 All-Reduce 组通信库 ，以
减少跨主机通信并充分利用内部高速带宽 。具体来说 ，对于
一次推理任务 ，当需要进行 All-Reduce 操作时 ，通信树的构
造过程如下 ：
首先在各主机内部选出性能最优的计算节点作为本地主
节点 （LM） ，用于本地聚合 。所有主机中的 LM之一被选为
全局聚合的全局主控 （GM） 。通信树的通信按照以下 4个步
骤完成 ：
1）每个计算节点将自己的局部计算结果发送到各自的
LM（仅限主机内推理流量 ） ；
2）所有的 LM将本地聚合结果发送至 GM以进行全局聚
合（仅主机间流量 ） ；
3）GM完成全局聚合 ，然后使用反向路由将全局聚合
结果传播回 LM；
4）LM将全局聚合块扇出到所有计算节点 。
与朴素 All-Reduce 主机间通信次数相比 ，采用通信树策
略后 ，主机间的 All-Reduce 通信次数降为仅需主机的数量 -1
次。可以看到 ，本方案充分利用了数据中心网络的结构特
点，通过优化内部节点的通信路径 ，有效管理推理中间结果
的聚合和分发过程 ，从而大幅度降低了主机间的通信频率和
通信延迟 ，提高了整体推理效率 。
2.3 面向 LLM、小显存集群的显存管理与调度
尽管针对 LLM 的内存卸载技术在高性能计算中心依然
有效 ，但这些主要为训练而设计的技术在资源受限的分布式
推理场景中应用可能不理想 。它们可能增加对计算资源的依
赖，加重通信负担 ，同时忽略了推理特有的计算需求和优化
吞吐量的机会 。通常来讲 ，LLM
推理包含预填充和解码两阶段 。
其中 ，预填充阶段并行处理输入 ，
解码阶段依赖之前所有 tokens 信息
生成新 tokens 。为提高效率 ，现有
工作提出将这些信息以键 （K）和
值（V）的形式缓存于显存中 ，大
大减少了重复计算次数 。但随着
对长序列推理的需求不断增长 ，
与模型权重和其他激活所需的工
作空间相比 ，KV缓存的显存占用
成为主要优化目标 。
为解决这个问题 ，我们开发
了一套针对 LLM 和小显存集群的
细粒度显存管理与调度机制 ，目
GM：全局主节点      GPU ：图形处理器      LM ：本地主节点      ToR ：架顶式
图2 通信树工作流程示意图机架 1主机 1 主机 2
节点 1
节点 2节点 3
节点 4GPU 0 GPU 1
LMGPU 2 GPU 3
LM&GM节点 5
节点 6节点 7
节点 8
ToR 交换机
通信树的分层聚合 ： 主机内聚合 机架内主机间聚合211
46