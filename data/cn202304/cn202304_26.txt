面向算力网络的多路径时敏优先调度机制 夏华屹  等 热点专题
中兴通讯技术
2023  年 8 月    第 29 卷第  4 期   Aug . 2023    Vol . 29  No. 41.3 优先队列调度模块设计
当路径选择模块选定具体的传输路径后 ，算力网络中多
种网络业务并存且需求带宽大于出口带宽时 ，时延敏感型算
力服务会产生较大的排队时延 ，难以满足用户需求 。因此 ，
本文中我们在可编程交换设备出端口设计了优先级队列调度
模块 ，设计包等级与队列自适应映射算法拟合数据包推入先
出行为 ，减少低时延需求数据包的排队时延 。我们基于 P4
数据平面实现的自适应队列调度机制简称为 P4-APQ 。
包等级与队列自适应映射算法的示意如图 2所示 ，其作
用场景为数据包等级范围大于优先队列数量 。该调度算法可
利用有限严格优先级队列来拟合数据包的推入先出过程 ，即
数据包近似按等级顺序出队列 （本文中 ，我们约定等级越
小，调度优先度越高 ） 。自适应映射算法误差定义为较大等
级数据包数量小于较小等级数据包出队的数据包数量 ，我们
将这种误差的现象称为 “反转 ” 。由于利用了严格优先级队
列拟合推入先出行为即按等级顺序出队 ，因此当数据包等级
范围大于严格优先级队列数量时 ，有一定概率在调度过程中
会出现 “反转 ”现象 。对于本文所设计的包等级 -队列映
射，设计目的为在保证小等级数据包优先调度的前提下 ，尽
可能按等级顺序出队 ，减少 “反转 ”现象 。
针对算力网络时敏型业务低时延需求 ，包等级与队列自
适应映射机制设计了高优先级预留队列 ，避免最小等级的数
据包因优先级 “反转 ”现象而出现较高的排队时延 。具体
地，首先判定数据平面传入数据包的等级 ；若等级最小 ，数
据包将直接进入具有最高优先级的预留队列 ，从而避免等级
队列的动态映射带来的 “反转 ”损失 。
当数据包等级不是最小时 ，为保证队列调度结果近似按
等级顺序出队 ，我们设计了自适应映射算法 ，动态改变各队
列的边界值 ，以最小化拟合损失 。自适应映射算法的损失函数可以描述为公式 （11） ：
L(Ρ，q)=∑ 
p∈Ρcostq(p)， （11）
其中 ，L表示为拟合损失 ，P表示所有入队数据包 ，qq表示一
组动态变化的队列边界向量 ，p表示属于 P的一个入队数据
包。单个数据包的损失可以表示为公式 （12） ：
costq(p)=rp(p，q)-r(p)， （12）
其中 ，r(p)表示为给定的数据包 p的等级 ，rp(p,q)表示为给定
数据包所映射的队列自适应调整后的边界值 ，cost表示单个
数据包产生的误差 ，即出现 “反转 ”的情况 。包等级与队列
自适应映射算法通过动态调整数据包等级与各优先队列的映
射关系 ，在兼顾数据平面的算法复杂度基础上 ，降低损失函
数L。
包等级与队列自适应映射算法可分为两个阶段 ：
1） “上推 ”阶段 。在该阶段 ，通过增加进入数据包所映
射队列的边界值 ，减少数据包分组等级与队列边界值的差
值，从而减少映射中出现的误差值 。具体地 ，传入的数据包
将从较低优先级的队列开始匹配 。当数据包等级 r(p)大于等
于队列边界 qqi时，数据包进入该队列 ，同时将队列边界 qqi增
加到等于该数据包等级 r(p)。该过程可以尽量保证数据包实
现零误差映射 ，并防止等级小于队列边界值的数据包映射到
当前队列 。以上设计仅针对非最高优先级队列 。当映射过程
匹配到最高优先级队列 （不包括预留队列 ） ，即使 r(p)<q1时，
当前数据包会进入最高优先级队列 。这将出现 “反转 ”现
象，并带来较大的映射损失 。这时 ，我们将根据公式 （12）
来计算误差损失 ，并更新最高优先级队列边界值为该数据包
等级 。
2） “下推 ”阶段 。由于 “上推 ”阶段可能导致最高优先
级队列出现 “反转 ”现象 ， “下推 ”
阶段将减少 “上推 ”阶段的调度损
失。当最高优先级队列出现 “反转 ”
现 象 时 ，自 适 应 算 法 将 根 据 公 式
（12）来计算损失成本 ，再根据公式
（13）依次减少除最高优先级队列以
外的队列边界 。该阶段降低了最高优
先级以外的队列边界 ，减少较高优先
级队列中允许进入的数据包等级范
围，即减少等级较大的数据包进入高
优先级队列的情况 ，进而减少出现
“反转 ”现象 ，降低调度损失 。
 图2 包等级与队列自适应 映射算法示意图实时调整映射关系传入数据包直接进入
预留队列
是
是否最高
优先级
否
自适应
映射算法
自适应后队列边界
q={2,4,5}输出数据包
r≥qqi？
（自下而
上）队列 0
队列 1
队列 2
队列 32 4 1 3 5 4
5 4 4 3 2 11
2
4 3
5 42
 
4
 
5
22